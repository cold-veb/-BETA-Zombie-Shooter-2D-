<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Zombie Shooter</title>
<style>
html, body {margin:0;padding:0;overflow:hidden;background:black;font-family:Arial;color:white;}
canvas {display:block;}
.menu,.gameover,.modes,.battlepass,.shop,.unitUpgrade {position:fixed;inset:0;background:#0044cc;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10;}
.hidden {display:none;}
button {padding:14px 22px;margin:10px;font-size:18px;border:none;border-radius:10px;cursor:pointer;}
.balance {position:absolute;top:15px;right:20px;font-size:20px;}
.stats {margin-top:10px;font-size:18px;white-space: pre-line;}
.task {margin:10px;text-align:center;}
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="menu" class="menu">
  <div class="balance" id="menuCoins">üí∞ 0</div>
  <h1>üßü Zombie Shooter</h1>
  <button onclick="openModes()">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
  <button onclick="openBattlePass()">üéü –ó–∞–¥–∞–Ω–∏—è</button>
  <button onclick="openShop()">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
  <div class="stats" id="menuStats"></div>
</div>

<div id="modes" class="modes hidden">
  <h1>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</h1>
  <button onclick="selectMode('standard')">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (5 –≤–æ–ª–Ω)</button>
  <button onclick="selectMode('christmas')">üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π‚õÑ</button>
  <button onclick="openUnitUpgrade()">‚öî –£–ª—É—á—à–∏—Ç—å –Æ–Ω–∏—Ç–æ–≤</button>
  <button onclick="openMenu()">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<div id="battlepass" class="battlepass hidden">
  <h1>üéü –ó–∞–¥–∞–Ω–∏—è</h1>
  <div class="task"><div>–£–±–∏—Ç—å 50 –∑–æ–º–±–∏</div><div id="task1"></div></div>
  <div class="task"><div>–£–±–∏—Ç—å 200 –∑–æ–º–±–∏</div><div id="task2"></div></div>
  <div class="task"><div>–£–±–∏—Ç—å 1000 –∑–æ–º–±–∏</div><div id="task3"></div></div>
  <button onclick="claimRewards()">üí∞ –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É</button>
  <button onclick="openMenu()">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<div id="shop" class="shop hidden">
  <h1>üõí –ú–∞–≥–∞–∑–∏–Ω</h1>
  <div id="shopItems"></div>
  <button onclick="openMenu()">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<div id="gameover" class="gameover hidden">
  <h1>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</h1>
  <button onclick="startGame()">üîÅ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  <button onclick="openMenu()">üìã –ú–µ–Ω—é</button>
</div>

<div id="unitUpgrade" class="unitUpgrade hidden">
  <h1>‚öî –£–ª—É—á—à–µ–Ω–∏–µ –Æ–Ω–∏—Ç–æ–≤</h1>
  <div id="unitList"></div>
  <button onclick="backToModes()">‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
resize(); addEventListener("resize",resize);

let state="menu", zombies=[], bullets=[], kills=0, chests=[], bags=[];
let coins=Number(localStorage.getItem("coins"))||0;
let totalKills=Number(localStorage.getItem("totalKills"))||0;

let wave=1,waveTime=20,waveTimer=20;
let spawnRate=0.02,zombieSpeed=1.2,lastTime=Date.now();
let currentMode="standard";

let weapons = {
  "Pistol": {delay:0.8, bullets:1, spread:false, owned:true, price:0, ammo:13, maxAmmo:13},
  "Tek-9": {delay:0.5, bullets:2, spread:false, owned:false, price:200, ammo:13, maxAmmo:13},
  "Shotgun": {delay:1, bullets:5, spread:true, owned:false, price:350, ammo:8, maxAmmo:8},
  "UMP": {delay:0.6, bullets:3, spread:true, owned:false, price:1000, ammo:15, maxAmmo:15}
};
let currentWeapon="Pistol", lastShot=0;
let reloading=false, reloadTime=3000, reloadStart=0;

let baseHP = 250;

let units = JSON.parse(localStorage.getItem("units")) || []; // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É–ø–ª–µ–Ω–Ω—ã–µ —é–Ω–∏—Ç—ã
const UNIT_FIRE_DELAY = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã
let maxUnits = 2;
let unitStats = [
  {name:"–ß–µ–ª–æ–≤–µ–∫ —Å –ø–∏—Å—Ç–æ–ª–µ—Ç–æ–º", dmg:1, delay:1000},
  {name:"–ß–µ–ª–æ–≤–µ–∫ —Å –¥—Ä–æ–±–æ–≤–∏–∫–æ–º", dmg:1, delay:1000},
  {name:"–ß–µ–ª–æ–≤–µ–∫ —Å UMP", dmg:1, delay:1000}
];

let lastClaim = Number(localStorage.getItem("lastClaim")) || 0;

// === –ú–ï–ù–Æ ===
function hideAll(){
  menu.classList.add("hidden");
  modes.classList.add("hidden");
  battlepass.classList.add("hidden");
  shop.classList.add("hidden");
  gameover.classList.add("hidden");
  unitUpgrade.classList.add("hidden");
  canvas.style.pointerEvents="auto";
}
function openMenu(){hideAll();state="menu";updateMenu();menu.classList.remove("hidden");canvas.style.pointerEvents="none";}
function openModes(){hideAll();modes.classList.remove("hidden");canvas.style.pointerEvents="none";}
function openBattlePass(){hideAll();battlepass.classList.remove("hidden");updateTasks();canvas.style.pointerEvents="none";}
function openShop(){hideAll();shop.classList.remove("hidden");updateShop();canvas.style.pointerEvents="none";}
function selectMode(m){currentMode=m;startGame();}
function backToModes(){hideAll();modes.classList.remove("hidden");canvas.style.pointerEvents="none";}

// HUD
function updateMenu(){
  menuCoins.innerText="üí∞ "+coins;
  menuStats.innerText=`–£–±–∏–π—Å—Ç–≤ –≤—Å–µ–≥–æ: ${totalKills}\n–ë–∞–∑–∞ HP: ${baseHP}`;
}
function updateTasks(){
  task1.innerText=Math.min(totalKills,50)+"/50";
  task2.innerText=Math.min(totalKills,200)+"/200";
  task3.innerText=Math.min(totalKills,1000)+"/1000";
}
function claimRewards(){
  let now = Date.now();
  if(now - lastClaim < 30*60*1000) return alert("–ù–∞–≥—Ä–∞–¥—É –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç");
  coins += 50;
  lastClaim = now;
  localStorage.setItem("lastClaim", lastClaim);
  saveProgress(); updateMenu();
  alert("–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!");
}

// –ú–∞–≥–∞–∑–∏–Ω
function updateShop(){
  let html="";
  for(let w in weapons){
    let weap = weapons[w];
    html += `<div><b>${w}</b> - ${weap.price}üí∞<br>
      <button onclick="buyEquip('${w}')">${weap.owned ? (currentWeapon===w?"–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ":"–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å"):"–ö—É–ø–∏—Ç—å"}</button></div>`;
  }
  shopItems.innerHTML=html;
}
function buyEquip(w){
  let weap = weapons[w];
  if(!weap.owned){
    if(coins<weap.price) return alert("–ù–µ—Ç –º–æ–Ω–µ—Ç");
    coins -= weap.price;
    weap.owned=true;
  }
  currentWeapon=w;
  updateShop(); updateMenu(); saveProgress();
}

// –°–ø–∞–≤–Ω
function spawnZombie(){ zombies.push({x:Math.random()*(canvas.width-40),y:-40,hp:1}); }
function spawnChest(){ if(Math.random()<0.001 && chests.length<3) chests.push({x:Math.random()*(canvas.width-40),y:-40,size:25}); }
function spawnBag(){ if(Math.random()<0.2 && bags.length<2) bags.push({x:Math.random()*(canvas.width-30),y:-40,r:15}); }

// –°—Ç—Ä–µ–ª—å–±–∞
canvas.addEventListener("mousedown", shoot);
function shoot(e){
  if(state!=="game" || reloading) return;
  let now=Date.now();
  let weap = weapons[currentWeapon];
  if(now-lastShot < weap.delay*1000) return;
  lastShot = now;
  for(let i=0;i<weap.bullets;i++){
    let offset = weap.spread ? (Math.random()*20-10) : 0;
    bullets.push({x:e.clientX+offset, y:canvas.height-80});
  }
  weap.ammo--;
  if(weap.ammo<=0){ reloading = true; reloadStart = Date.now(); }
}

// –°–Ω–µ–≥
let snowflakes=[];
function spawnSnow(){
  if(currentMode==="christmas"){
    for(let i=0;i<1;i++) snowflakes.push({x:Math.random()*canvas.width,y:0,r:Math.random()*2+1});
  }
}
function drawSnow(){
  ctx.fillStyle="white";
  snowflakes.forEach((s,i)=>{
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
    s.y += 1+s.r/2; if(s.y>canvas.height) snowflakes.splice(i,1);
  });
}

// –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
function startGame(){
  state="game"; zombies=[]; bullets=[]; chests=[]; bags=[];
  kills=0; wave=1; waveTimer=waveTime; spawnRate=0.02; zombieSpeed=1.2; baseHP=250;
  for(let w in weapons) weapons[w].ammo = weapons[w].maxAmmo;
  reloading=false;

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ —é–Ω–∏—Ç–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã
  units.forEach(u=>{
    if(u.xPos) { u.x = u.xPos; u.y = u.yPos; }
    else u.x = null;
  });

  hideAll();
}

// –ê–ø–≥—Ä–µ–π–¥ —é–Ω–∏—Ç–æ–≤
function openUnitUpgrade() {
  hideAll();
  document.getElementById("unitUpgrade").classList.remove("hidden");
  updateUnitUpgrade();
}
function updateUnitUpgrade() {
  let html = "";
  const unitNames = ["–ß–µ–ª–æ–≤–µ–∫ —Å –ø–∏—Å—Ç–æ–ª–µ—Ç–æ–º","–ß–µ–ª–æ–≤–µ–∫ —Å –¥—Ä–æ–±–æ–≤–∏–∫–æ–º","–ß–µ–ª–æ–≤–µ–∫ —Å UMP"];
  const unitPrices = [350,750,1500];
  for(let i=0;i<unitNames.length;i++){
    let count = units.filter(u=>u.index===i).length;
    html += `<div style="margin:15px;">
      <b>${unitNames[i]}</b> - ${unitPrices[i]}üí∞<br>
      <button onclick="buyUnit(${i},${unitPrices[i]})">–ö—É–ø–∏—Ç—å</button>`;
    if(count>0){
      html += ` <button onclick="equipUnit(${i},${count})">–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å ${count>1?'–¥–≤—É—Ö':'–æ–¥–Ω–æ–≥–æ'}</button>`;
    }
    html += `</div>`;
  }
  document.getElementById("unitList").innerHTML = html;
}
function buyUnit(index, price){
  if(coins < price) return alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç!");
  coins -= price;
  let weapon = index===0?"Pistol":index===1?"Shotgun":"UMP";
  units.push({index:index, weapon:weapon, lastShot:0, x:null, y:null, xPos:null, yPos:null});
  saveProgress(); updateUnitUpgrade(); updateMenu();
}
function equipUnit(index, count){
  let toEquip = units.filter(u=>u.index===index && u.x===null);
  if(toEquip.length===0) return alert("–í—Å–µ –∫—É–ø–ª–µ–Ω–Ω—ã–µ —é–Ω–∏—Ç—ã —É–∂–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω—ã!");
  toEquip.slice(0,count).forEach((u,i)=>{
    u.x = canvas.width/2 - 12 + (i*30); // —Ä—è–¥–æ–º —Å –±–∞–∑–æ–π
    u.y = canvas.height-80;
    u.xPos = u.x; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
    u.yPos = u.y;
    u.lastShot = 0;
  });
  saveProgress();
  updateUnitUpgrade();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
function update(){
  if(state!=="game") return;
  if(reloading && Date.now()-reloadStart>reloadTime){ reloading=false; weapons[currentWeapon].ammo = weapons[currentWeapon].maxAmmo; }
  waveTimer -= 0.016;
  if(Math.random()<spawnRate) spawnZombie();
  spawnChest(); spawnBag(); spawnSnow();
  if(waveTimer<=0){
    wave++;
    if(currentMode==="standard" && wave>5) endGame();
    if(currentMode==="christmas" && wave>10) endGame();
    waveTimer = waveTime;
    zombieSpeed += 0.2;
    spawnRate += 0.01;
  }

  bullets.forEach(b=>b.y-=12);

  for(let i=zombies.length-1;i>=0;i--){
    let z = zombies[i], hit=false;
    for(let j=bullets.length-1;j>=0;j--){
      let b = bullets[j];
      if(b.x>z.x && b.x<z.x+35 && b.y>z.y && b.y<z.y+35){
        z.hp--; bullets.splice(j,1); hit=true;
        if(z.hp<=0){ zombies.splice(i,1); kills++; totalKills++; coins++; saveProgress(); }
        break;
      }
    }
    if(!hit) z.y += zombieSpeed;
    if(z.y>canvas.height-50){ baseHP-=20; zombies.splice(i,1); }
  }

  for(let i=chests.length-1;i>=0;i--){
    let c = chests[i];
    for(let j=bullets.length-1;j>=0;j--){
      let b = bullets[j];
      if(b.x>c.x && b.x<c.x+c.size && b.y>c.y && b.y<c.y+c.size){
        coins+=5; bullets.splice(j,1); chests.splice(i,1); saveProgress(); break;
      }
    }
    c.y+=1.5;
  }

  for(let i=bags.length-1;i>=0;i--){
    let b = bags[i];
    for(let j=bullets.length-1;j>=0;j--){
      let bl = bullets[j];
      if(Math.hypot(bl.x-(b.x+b.r), bl.y-(b.y+b.r))<b.r){
        coins+=15; bullets.splice(j,1); bags.splice(i,1); saveProgress(); break;
      }
    }
    b.y+=1.5;
  }

  // –Æ–Ω–∏—Ç—ã —Å—Ç—Ä–µ–ª—è—é—Ç
  units.forEach(u=>{
    if(u.x===null) return;
    let now=Date.now();
    if(now-u.lastShot>=UNIT_FIRE_DELAY && zombies.length>0){
      let target = zombies.reduce((a,b)=>Math.hypot(a.x-u.x,a.y-u.y)<Math.hypot(b.x-u.x,b.y-u.y)?a:b);
      bullets.push({x:u.x+12, y:u.y, target:target});
      u.lastShot=now;
    }
  });

  if(baseHP<=0) endGame();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
function saveProgress(){ 
  localStorage.setItem("coins", coins); 
  localStorage.setItem("totalKills", totalKills);
  localStorage.setItem("units", JSON.stringify(units));
}
function endGame(){ state="over"; hideAll(); gameover.classList.remove("hidden"); updateMenu(); saveProgress(); }

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle=currentMode==="christmas"?"#1e3f66":"#228B22";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  if(state!=="game") return;
  ctx.fillStyle="red"; ctx.fillRect(0,canvas.height-50,canvas.width,50);
  ctx.fillStyle="white"; ctx.font="20px Arial";
  ctx.fillText(`üß± –ë–∞–∑–∞ HP: ${baseHP}`,10,30);
  ctx.fillText(`üåä –í–æ–ª–Ω–∞ ${wave} : ${Math.ceil(waveTimer)} —Å–µ–∫`,10,60);
  ctx.fillText(`üíÄ –£–±–∏–π—Å—Ç–≤–∞: ${kills}`,10,90);
  if(reloading){ ctx.fillStyle="yellow"; ctx.font="30px Arial"; ctx.fillText("–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞...",canvas.width/2-80,50); }
  if(currentMode==="christmas") drawSnow();
  ctx.fillStyle="yellow"; bullets.forEach(b=>ctx.fillRect(b.x-3,b.y,6,12));
  ctx.fillStyle="green"; zombies.forEach(z=>ctx.fillRect(z.x,z.y,35,35));
  ctx.fillStyle="orange"; chests.forEach(c=>ctx.fillRect(c.x,c.y,c.size,c.size));
  ctx.fillStyle="yellow"; ctx.font="20px Arial"; bags.forEach(b=>{ctx.beginPath();ctx.arc(b.x+b.r,b.y+b.r,b.r,0,Math.PI*2);ctx.fill();ctx.fillText("üí∞",b.x+b.r-10,b.y+b.r+7);});
  ctx.fillStyle="blue"; units.forEach(u=>{if(u.x!==null) ctx.fillRect(u.x,u.y,25,25);});
  ctx.fillStyle="#0044cc"; ctx.fillRect(canvas.width-110,10,100,40);
  ctx.fillStyle="white"; ctx.fillText("–ú–µ–Ω—é",canvas.width-90,35);
}

// –ú–µ–Ω—é —á–µ—Ä–µ–∑ –∫–ª–∏–∫
canvas.addEventListener("click",(e)=>{
  if(state==="game" && e.clientX>canvas.width-110 && e.clientX<canvas.width-10 && e.clientY>10 && e.clientY<50){
    openMenu();
  }
});

// –¶–∏–∫–ª –∏–≥—Ä—ã
function loop() {
    update();  // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É –∏–≥—Ä—ã
    draw();    // —Ä–∏—Å—É–µ–º –≤—Å—ë –Ω–∞ –∫–∞–Ω–≤–∞—Å–µ
    requestAnimationFrame(loop); // –ø–æ–≤—Ç–æ—Ä—è–µ–º —Ü–∏–∫–ª –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –∫–∞–¥—Ä–µ
}

// –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
loop();
</script>
</body>
</html>